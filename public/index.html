<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Send Location (form/iframe method)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
</head>
<body>
  <h2>Send Location to Google Sheet</h2>
  <p id="status">Press the button to share location.</p>
  <button id="sendBtn">Get location & send</button>

  <script>
    // ----- CONFIG -----
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby15x1sTy0-MWhfswHVKds1bTFnbJn67-4F5FMbAHUMaEWDceGRF2jx_MlvQMpkjYDw/exec'; // e.g. https://script.google.com/macros/s/XXXXXXXXXX/exec
    const SECRET_TOKEN = 'bumblebee'; // same as SECRET in Apps Script
    // ------------------

    const statusEl = document.getElementById('status');
    const btn = document.getElementById('sendBtn');

    btn.addEventListener('click', () => {
      statusEl.textContent = 'Requesting location permission...';
      if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation not supported in this browser.';
        return;
      }
      navigator.geolocation.getCurrentPosition(success, fail, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    });

    function success(pos) {
      statusEl.textContent = 'Got location. Sending...';
      sendViaForm(pos).then(r => {
        if (r && r.ok) {
          statusEl.textContent = 'Sent successfully! Check the Google Sheet.';
        } else {
          statusEl.textContent = 'Send may have failed. See console for details.';
          console.log('send result', r);
        }
      });
    }

    function fail(err) {
      statusEl.textContent = 'Location error: ' + err.message;
    }

    // ---- sendViaForm: posts to Apps Script via a hidden form + iframe ----
    async function sendViaForm(position) {
      if (!position || !position.coords) return { ok:false, error:'no coords' };
      // create hidden iframe
      const iframe = document.createElement('iframe');
      iframe.name = 'hidden_iframe_' + Date.now();
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // create form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name;
      form.style.display = 'none';

      const addInput = (name, value) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value === undefined ? '' : String(value);
        form.appendChild(input);
      };

      addInput('token', SECRET_TOKEN);
      addInput('lat', position.coords.latitude);
      addInput('lon', position.coords.longitude);
      addInput('accuracy', position.coords.accuracy || '');
      addInput('userAgent', navigator.userAgent);
      addInput('extra', navigator.language || '');

      document.body.appendChild(form);

      return new Promise((resolve) => {
        // If iframe loads a response, we assume POST completed.
        iframe.onload = function() {
          // cleanup
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true });
        };
        // submit form (this avoids CORS preflight)
        form.submit();
        // fallback in case onload doesn't fire (some browsers)
        setTimeout(() => {
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true, note:'timeout fallback' });
        }, 6000);
      });
    }
  </script>
</body>
</html>
