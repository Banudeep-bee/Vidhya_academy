<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Send Location (form/iframe method)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
</head>
<body>
  <h2>Send Location to Google Sheet</h2>
  <p id="status">Press the button to share location.</p>
  <button id="sendBtn">Get location & send</button>

  <script>
    // ----- CONFIG -----
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwV9b3Mt776QU1OfdjNWJMaYV3sxPGQOyL49Nu-0jt3Y1pcYHsz4iNER-P540RTgWJi/exec'; // e.g. https://script.google.com/macros/s/XXXXXXXXXX/exec
    const SECRET_TOKEN = 'bumblebee'; // same as SECRET in Apps Script
    // ------------------

    const statusEl = document.getElementById('status');
    const btn = document.getElementById('sendBtn');

    btn.addEventListener('click', () => {
      statusEl.textContent = 'Requesting location permission...';
      if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation not supported in this browser.';
        return;
      }
      navigator.geolocation.getCurrentPosition(success, fail, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    });

    function success(pos) {
      statusEl.textContent = 'Got location. Sending...';
      sendViaForm(pos).then(r => {
        if (r && r.ok) {
          statusEl.textContent = 'Sent successfully! Check the Google Sheet.';
        } else {
          statusEl.textContent = 'Send may have failed. See console for details.';
          console.log('send result', r);
        }
      });
    }

    function fail(err) {
      statusEl.textContent = 'Location error: ' + err.message;
    }
    // Reverse geocode helper (best-effort; may return null)
    async function reverseGeocodeText(lat, lon) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1`;
        const res = await fetch(url, { headers: { 'User-Agent': 'exact-location-demo/1.0 (contact@example.com)' }});
        if (!res.ok) return null;
        const json = await res.json();
        return json.display_name || null;
      } catch (e) {
        return null;
      }
    }

    // Updated sendViaForm with richer data & reverse geocode
    async function sendViaForm(position) {
      if (!position || !position.coords) return { ok:false, error:'no coords' };

      // Prepare fields
      const latRaw = position.coords.latitude;
      const lonRaw = position.coords.longitude;
      const lat = latRaw.toFixed(6); // human-readable precision
      const lon = lonRaw.toFixed(6);
      const accuracy = Math.round(position.coords.accuracy || 0);
      const isoTs = new Date(position.timestamp).toISOString();
      const rawJson = JSON.stringify(position);
      const ua = navigator.userAgent;
      const extra = navigator.language || '';

      // Attempt reverse geocode (non-blocking failure)
      let address = null;
      try { address = await reverseGeocodeText(latRaw, lonRaw); } catch(e) { address = null; }

      // create hidden iframe
      const iframe = document.createElement('iframe');
      iframe.name = 'hidden_iframe_' + Date.now();
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // create form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name;
      form.style.display = 'none';

      const addInput = (name, value) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value === undefined || value === null ? '' : String(value);
        form.appendChild(input);
      };

      addInput('token', SECRET_TOKEN);
      addInput('lat', lat);
      addInput('lon', lon);
      addInput('lat_raw', latRaw);
      addInput('lon_raw', lonRaw);
      addInput('accuracy', accuracy);
      addInput('timestamp_iso', isoTs);
      addInput('address', address || '');
      addInput('raw', rawJson);
      addInput('userAgent', ua);
      addInput('extra', extra);

      document.body.appendChild(form);

      return new Promise((resolve) => {
        iframe.onload = function() {
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true });
        };
        form.submit();
        setTimeout(() => {
          try { document.body.removeChild(form); } catch(e){}
          try { document.body.removeChild(iframe); } catch(e){}
          resolve({ ok:true, note:'timeout fallback' });
        }, 6000);
      });
    }
  </script>
</body>
</html>
